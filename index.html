<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Boxicons -->
    <link
      href="https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css"
      rel="stylesheet"
    />
    <!-- My CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="./img/logoTelkom.png" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <title>DDoS Threat Map</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      #map-container {
        width: 75vw;
        height: 75vh;
        padding: 10px;
        background-color: #060714;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        margin-left: 12.25vw;
        margin-top: 10vh;
      }

      svg {
        width: 100%;
        height: 100%;
        border-radius: 10px;
      }

      .land {
        fill: grey;
        stroke: #333;
        stroke-width: 0.5px;
      }

      .land:hover {
        fill: blue;
      }

      .markerRed {
        fill: red;
        stroke: black;
        stroke-width: 1px;
      }
      .markerYellow {
        fill: yellow;
        stroke: black;
        stroke-width: 1px;
      }

      .pulseRed {
        fill: none;
        stroke: red;
        stroke-width: 2px;
        opacity: 0.7;
      }
      .pulseYellow {
        fill: none;
        stroke: yellow;
        stroke-width: 2px;
        opacity: 0.7;
      }
      .modal-content {
        background-color: #1e1e1e;
        color: white;
      }

      .modal-header {
        border-bottom: 1px solid #444;
      }

      .modal-footer {
        border-top: 1px solid #444;
      }

      .lineRed {
        fill: none;
        stroke: red;
        stroke-width: 2px;
        opacity: 0.7;
      }
      .lineYellow {
        fill: none;
        stroke: yellow;
        stroke-width: 2px;
        opacity: 0.7;
      }
      /* Pastikan untuk menyertakan Bootstrap CSS dalam proyek Anda, jika belum */
      .modal-content {
        background-color: #1e1e1e; /* Dark background */
        color: white; /* Light text color */
      }

      /* Modal Footer */
      .modal-footer {
        border-top: 1px solid #444; /* Sesuaikan dengan desain Anda */
      }

      /* Pastikan Bootstrap CSS sudah ada di proyek */
    </style>
  </head>
  <body class="dark">
    <!-- NAVBAR -->
    <nav>
      <img src="./img/logoTelkom.png" id="logo" />
    </nav>
    <!-- NAVBAR -->

    <!-- MAIN -->
    <main>
      <ul class="box-info">
        <li>
          <i class="fa-solid fa-land-mine-on fa-2xl" style="color: #74c0fc"></i>
          <span class="text">
            <h3 id="ongoing-attack-count">0</h3>
            <p>On-going Attack</p>
          </span>
        </li>
      </ul>
      <div id="map-container">
        <svg></svg>
      </div>
    </main>
    <!-- MAIN -->

    <!-- Modal HTML -->
    <div
      class="modal fade"
      id="recordModal"
      tabindex="-1"
      aria-labelledby="recordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="recordModalLabel">Attack Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p><strong>ID:</strong> <span id="modal-id"></span></p>
            <p><strong>CHK:</strong> <span id="modal-chk"></span></p>
            <p>
              <strong>Direction:</strong> <span id="modal-direction"></span>
            </p>
            <p><strong>Resource:</strong> <span id="modal-resource"></span></p>
            <p><strong>Severity:</strong> <span id="modal-severity"></span></p>
            <p>
              <strong>StartTime:</strong> <span id="modal-starttime"></span>
            </p>
            <p><strong>Type:</strong> <span id="modal-type"></span></p>
            <p><strong>Victim Ip:</strong> <span id="modal-victimip"></span></p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div
      id="detailMapAttack"
      class="modal fade"
      tabindex="-1"
      role="dialog"
      aria-labelledby="modalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel">Attack Details</h5>
            <!-- Tidak ada tombol close di header -->
          </div>
          <div class="modal-body" id="modal-body">
            <!-- Data akan dimasukkan di sini oleh JavaScript -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script type="module">
      import {
        select,
        json,
        geoPath,
        geoNaturalEarth1,
        zoom,
        easeCubicInOut,
      } from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
      import { feature } from "https://cdn.jsdelivr.net/npm/topojson@3/+esm";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        Timestamp,
        doc,
        updateDoc,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
      import dayjs from "https://cdn.jsdelivr.net/npm/dayjs@1.10.4/+esm";
      import utc from "https://cdn.jsdelivr.net/npm/dayjs@1.10.4/plugin/utc/+esm";
      import anime from "https://cdn.jsdelivr.net/npm/animejs@3.2.1/+esm";

      dayjs.extend(utc);
      const ws = new WebSocket("ws:/localhost:8080");

      let onGoingAttack = [];

      function transformData(data) {
        let returnVal = {
          Status: "Ongoing",
          ...data,
        };
        return returnVal;
      }

      function includeInArray(data, array) {
        const newSourceIp = data.from.src;
        const newDestIp = data.to.dst;
        return array.some(
          (item) => item.sourceIp == newSourceIp && item.destIp == newDestIp
        );
      }

      // Gunakan jQuery atau Vanilla JS untuk menampilkan modal dengan Bootstrap
      function showModal(data) {
        const modalBody = document.getElementById("modal-body");

        modalBody.innerHTML = `
    <strong>From:</strong> <br>
    <ul>
      <li><p>src: ${data.from.src || "N/A"}</p></li>
      <li><p>lat: ${data.from.lat || "N/A"}</p></li>
      <li><p>lng: ${data.from.lng || "N/A"}</p></li>
      <li><p>sourceGeoCountryCode: ${
        data.from.sourceGeoCountryCode || "N/A"
      }</p></li>
      <li><p>sourceGeoLocationInfo: ${
        data.from.sourceGeoLocationInfo || "N/A"
      }</p></li>
    </ul><br>
    <strong>To:</strong> <br>
    <ul>
      <li><p>dst: ${data.to.dst || "N/A"}</p></li>
      <li><p>lat: ${data.to.lat || "N/A"}</p></li>
      <li><p>lng: ${data.to.lng || "N/A"}</p></li>
      <li><p>dvchost: ${data.to.dvchost || "N/A"}</p></li>
      <li><p>cs5: ${data.to.cs5 || "N/A"}</p></li>
      <li><p>destinationGeoCountryCode: ${
        data.to.destinationGeoCountryCode || "N/A"
      }</p></li>
      <li><p>destinationGeoLocationInfo: ${
        data.to.destinationGeoLocationInfo || "N/A"
      }</p></li>
    </ul><br>
    <strong>Action:</strong> <br>
    <ul>
      <li><p>act: ${data.action.act || "N/A"}</p></li>
      <li><p>deviceSeverity: ${data.action.deviceSeverity || "N/A"}</p></li>
      <li><p>severity: ${data.action.severity || "N/A"}</p></li>
    </ul><br>
  `;

        // Gunakan Bootstrap modal method untuk menampilkan modal
        var myModal = new bootstrap.Modal(
          document.getElementById("detailMapAttack")
        );
        myModal.show();
      }

      function renderMarkerByStatus(el) {
        const attackId = el.from.src + el.to.dst;
        let startPulseAnimation, marker;

        const destLat = el.to.lat;
        const destLon = el.to.lng;
        const destCoords = projection([destLon, destLat]);
        console.log({ destLat, destLon });

        g.append("circle")
          .attr("cx", destCoords[0])
          .attr("cy", destCoords[1])
          .attr("r", 5)
          .attr("class", `marker marker-${attackId}`)
          .append("title");

        function createPulse() {
          const pulse = g
            .append("circle")
            .attr("class", `pulseRed pulse-${attackId}`)
            .attr("cx", destCoords[0])
            .attr("cy", destCoords[1])
            .attr("r", 5)
            .attr("opacity", 0.7);

          pulse
            .transition()
            .duration(1500)
            .ease(d3.easeCubicInOut)
            .attr("r", 25)
            .attr("opacity", 0)
            .on("end", () => {
              pulse.remove();
              if (startPulseAnimation && marker && !marker.empty()) {
                createPulse();
              }
            });
        }

        let idx = 0;

        function createMarker() {
          marker = g
            .append("circle")
            .attr("class", `markerRed marker-${attackId}`) // Menambahkan kelas khusus dengan ID
            .attr("cx", destCoords[0])
            .attr("cy", destCoords[1])
            .attr("r", 5)
            .on("click", (event) => {
              showModal(el);
            });

          startPulseAnimation = true;
          createPulse();
        }

        if (el.Status === "Ongoing") {
          createMarker();
        }

        // // Listener untuk memantau perubahan status
        // onSnapshot(doc(db, "DDosAttackIndonesia", attackId), (docSnapshot) => {
        //   const updatedData = docSnapshot.data();
        //   if (updatedData.Status !== "Ongoing") {
        //     // Menghapus elemen terkait dengan ID khusus
        //     g.selectAll(
        //       `.marker-${attackId}, .pulse-${attackId}, .line-${attackId}`
        //     ).remove();
        //     marker = null;
        //     startPulseAnimation = false;
        //   }
        // });
      }

      function animateCountUpdate(element, newValue) {
        const currentValue = parseInt(element.innerText);

        // Buat container untuk animasi
        const container = document.createElement("div");
        container.style.position = "relative";
        container.style.display = "inline-block";
        container.style.height = element.offsetHeight + "px"; // Tetapkan tinggi container agar tetap konsisten

        // Elemen nilai lama
        const oldValueElement = document.createElement("div");
        oldValueElement.innerText = currentValue;
        oldValueElement.style.position = "absolute";
        oldValueElement.style.top = "0";
        oldValueElement.style.left = "0";
        oldValueElement.style.fontSize = "24px";
        oldValueElement.style.fontWeight = "bold";
        container.appendChild(oldValueElement);

        // Elemen nilai baru
        const newValueElement = document.createElement("div");
        newValueElement.innerText = newValue;
        newValueElement.style.position = "absolute";
        newValueElement.style.top = "0";
        newValueElement.style.left = "0";
        newValueElement.style.fontSize = "24px";
        newValueElement.style.fontWeight = "bold";
        newValueElement.style.opacity = "0";
        container.appendChild(newValueElement);

        // Ganti elemen asli dengan container yang di-animasi
        element.innerHTML = "";
        element.appendChild(container);

        anime({
          targets: oldValueElement,
          translateY: -50,
          duration: 500,
          easing: "easeInOutQuad",
          complete: () => {
            oldValueElement.remove();
          },
        });

        anime({
          targets: newValueElement,
          opacity: [0, 1],
          translateY: [50, 0],
          duration: 500,
          easing: "easeInOutQuad",
          complete: () => {
            // Setelah animasi selesai, reset posisi elemen agar sesuai
            newValueElement.style.position = "static";
            container.style.height = "auto"; // Hapus tinggi tetap dari container setelah animasi
          },
        });
      }
      let countOnGoing = [];
      // Fungsi untuk menghitung dan memperbarui jumlah Ongoing Attack
      function updateOngoingAttackCount(event) {
        const data = transformData(JSON.parse(event.data));
        console.log(data);
        // cek apakah serangan sudah ada di dalam countOnGoing (berdasarkan sourceIp dan destinationIp)
        const newSourceIp = data.from.src;
        const newDestIp = data.to.dst;
        const include = countOnGoing.some(
          (item) => item.sourceIp == newSourceIp && item.destIp == newDestIp
        );
        if (data.Status === "Ongoing" && !include) {
          // Perbarui nilai pada elemen <h3>
          countOnGoing.push({ sourceIp: newSourceIp, destIp: newDestIp });
          animateCountUpdate(
            document.getElementById("ongoing-attack-count"),
            countOnGoing.length
          );
        } else {
          if (!(data.Status === "Ongoing") && include) {
            countOnGoing = countOnGoing.filter(
              (item) =>
                item.sourceIp !== newSourceIp && item.destIp !== newDestIp
            );
            // Perbarui nilai pada elemen <h3>
            animateCountUpdate(
              document.getElementById("ongoing-attack-count"),
              countOnGoing.length
            );
          }
        }
      }

      function listenToDDoSAttacks() {
        ws.onmessage = (event) => {
          const newAttackData = transformData(JSON.parse(event.data));
          console.log(newAttackData);

          if (
            newAttackData.Status === "Ongoing" &&
            !includeInArray(newAttackData, onGoingAttack)
          ) {
            renderMarkerByStatus(newAttackData);
            updateOngoingAttackCount(event);
            onGoingAttack.push({
              sourceIp: newAttackData.from.src,
              destIp: newAttackData.to.dst,
            });
          }
        };
      }

      // Panggil fungsi untuk memulai listener
      listenToDDoSAttacks();
      // updateOngoingAttackCount();
      // updateRedSeverityOngoingAttackCount();
      // updateYellowSeverityOngoingAttackCount();

      // Kode untuk memuat peta dan melakukan setup D3.js
      // Kode untuk memuat peta dan melakukan setup D3.js
      const svg = select("svg");

      const width = parseFloat(svg.style("width"));
      const height = parseFloat(svg.style("height"));

      const projection = geoNaturalEarth1()
        .center([120, -3])
        .scale(1800)
        .translate([width / 2, height / 2]);

      const pathGenerator = geoPath().projection(projection);

      svg
        .append("path")
        .attr("d", pathGenerator({ type: "Sphere" }))
        .attr("fill", "#060714");

      const g = svg.append("g");

      svg.call(
        zoom()
          .scaleExtent([1, 8])
          .on("zoom", (event) => {
            g.attr("transform", event.transform);
          })
      );

      json(
        "https://cdn.jsdelivr.net/npm/@trase/trase-atlas@1.1/files/indonesia.json"
      )
        .then((data) => {
          const geojson = feature(data, data.objects.level2);

          g.selectAll("path")
            .data(geojson.features)
            .enter()
            .append("path")
            .attr("class", "land")
            .attr("d", pathGenerator)
            .append("title")
            .text((d) => d.properties.name || "Unknown");
        })
        .catch((error) => console.error("Error fetching map data:", error));

      // Kode untuk menu dan resize event
      const allSideMenu = document.querySelectorAll(
        "#sidebar .side-menu.top li a"
      );

      allSideMenu.forEach((item) => {
        const li = item.parentElement;

        item.addEventListener("click", function () {
          allSideMenu.forEach((i) => {
            i.parentElement.classList.remove("active");
          });
          li.classList.add("active");
        });
      });

      window.addEventListener("resize", function () {
        if (this.innerWidth > 576) {
          searchButtonIcon.classList.replace("bx-x", "bx-search");
          searchForm.classList.remove("show");
        }
      });
    </script>
  </body>
</html>
